@inject school.Data.ApplicationDbContext _context

@if (table == null)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}

<MudTable ServerData="@(new Func<TableState, Task<TableData<Event>>>(ServerReload))" @ref="table" Hover="true" Breakpoint="Breakpoint.Sm">
    <HeaderContent>
        <MudTh>Datum</MudTh>
        <MudTh>Tid</MudTh>
        <MudTh>Typ</MudTh>
        <MudTh>Att göra</MudTh>
        <MudTh>Status</MudTh>
        <MudTh></MudTh>
        <MudTh></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Datum">@context.Datum.Value.ToShortDateString()</MudTd>
        <MudTd DataLabel="Tid">@string.Format("{0:00}:{1:00}", context.Tid.Value.Hours, context.Tid.Value.Minutes)</MudTd>
        <MudTd DataLabel="Typ">@context.Type</MudTd>
        <MudTd DataLabel="Att göra">@context.ToDo</MudTd>
        @if (!context.IsDone)
        {
            <MudTd DataLabel="Status">Inte klart</MudTd>
            <MudTd>
                <MudIconButton Color="Color.Success" OnClick="@(e => UpdateStatus(context.Id, true))" Icon="@Icons.Custom.Uncategorized.AlertSuccess" />
            </MudTd>
        }
        else
        {
            <MudTd DataLabel="Status">Klart!</MudTd>
            <MudTd>
                <MudIconButton Color="Color.Warning" OnClick="@(e => UpdateStatus(context.Id, false))" Icon="@Icons.Material.Filled.Redo" />
            </MudTd>
        }
        <MudTd>
            <MudIconButton Color="Color.Error" OnClick="@(e => Remove(context.Id))" Icon="@Icons.Material.Filled.Close" />
        </MudTd>
    </RowTemplate>
</MudTable>

@code {
    public MudTable<Event> table;

    // LOAD DATA FROM DATABASE
    private async Task<TableData<Event>> ServerReload(TableState state)
    {
        var results = await _context.Events.OrderByDescending(x => x.Datum).ToListAsync();
        StateHasChanged();
        return new TableData<Event>() { Items = results };
    }

    private async Task UpdateStatus(int id, bool b)
    {
        Event ev = await _context.Events.Where(x => x.Id == id).FirstOrDefaultAsync();
        ev.IsDone = b;

        _context.Events.Update(ev);
        _context.SaveChanges();
        StateHasChanged();
    }

    private async Task Remove(int id)
    {
        Event ev = await _context.Events.Where(x => x.Id == id).FirstOrDefaultAsync();

        _context.Events.Remove(ev);
        _context.SaveChanges();
        await table.ReloadServerData();
        StateHasChanged();
    }
}
